<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>PAG深度解读（二）：AE全特性支持 · PAG</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="---"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="PAG深度解读（二）：AE全特性支持 · PAG"/><meta property="og:type" content="website"/><meta property="og:url" content="https://pag.io/index.html"/><meta property="og:description" content="---"/><meta property="og:image" content="https://pag.io/img/docusaurus.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://pag.io/img/docusaurus.png"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://pagio-1251316161.cos.ap-nanjing.myqcloud.com/website/static/javascript/page.js"></script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://pagio-1251316161.file.myqcloud.com/website/static/javascript/pagjs/pag.min.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/new_official_website/logo.png" alt="PAG"/><h2 class="headerTitleWithLogo">PAG</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/" target="_self">首页</a></li><li class=""><a href="/docs/install.html" target="_self">设计师文档</a></li><li class=""><a href="/docs/sdk.html" target="_self">开发者文档</a></li><li class=""><a href="/case.html" target="_self">案例展示</a></li><li class=""><a href="/docs/faq.html" target="_self">FAQ</a></li><li class=""><a href="https://github.com/Tencent/libpag" target="_self">GitHub</a></li><li class=""><a href="https://qm.qq.com/cgi-bin/qm/qr?k=Wa65DTnEKo2hnPsvY-1EgJOF8tvKQ-ZT&amp;jump_from=webapi" target="_self">官方群</a></li><li class=""><a href="/#download" target="_self">免费下载</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>PAG深度解读</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">SDK接入</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/sdk.html">移动端接入指南</a></li><li class="navListItem"><a class="navItem" href="/docs/sdk-web.html">Web端接入指南</a></li><li class="navListItem"><a class="navItem" href="/docs/sdk-desktop.html">桌面端接入指南</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">PAG深度解读</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/pag-depth-1.html">PAG深度解读（一）：编辑架构演进</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/pag-depth-2.html">PAG深度解读（二）：AE全特性支持</a></li><li class="navListItem"><a class="navItem" href="/docs/pag-depth-3.html">PAG深度解读（三）：高效动画文件</a></li><li class="navListItem"><a class="navItem" href="/docs/pag-depth-4.html">PAG深度解读（四）：整合视频渲染</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">API参考</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/apis-ios.html">IOS API文档</a></li><li class="navListItem"><a class="navItem" href="/docs/apis-android.html">Android API文档</a></li><li class="navListItem"><a class="navItem" href="/docs/apis-web.html">Web API文档</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">素材迁移</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/lottie-migration.html">Lottie 迁移指南</a></li><li class="navListItem"><a class="navItem" href="/docs/animation-convertor.html">素材迁移说明</a></li><li class="navListItem"><a class="navItem" href="/docs/SDK-migration.html">PAG SDK 迁移指南</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">视频分享</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/qa.html">线上答疑</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">PAG深度解读（二）：AE全特性支持</h1></header><article><div><span><hr>
<blockquote>
<p>AE里有很多复杂动效，使用纯代码还原起来非常困难，设计师只能不断简化效果以达到跟开发成本的平衡。导致最终上线的视觉效果都是打过折扣的，不达设计预期。而PAG的SDK已经完全还原了AE整个动画的渲染系统，能够支持所有AE特性，设计师可以充分利用AE动画的原子能力，组合出无限的视觉动效，不用因为代码还原成本的问题而打折扣。本文将介绍PAG是如何实现AE全特性支持的。</p>
</blockquote>
<hr>
<h2><a class="anchor" aria-hidden="true" id="一矢量序列帧混合导出"></a><a href="#一矢量序列帧混合导出" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>一、矢量+序列帧混合导出</h2>
<p>我们在PAG 1.0的版本里，为了达到极限的动画文件大小，只实现了动画矢量导出方式的支持。矢量导出方式优势就是文件极小，并且可以运行时编辑动画的内容。但这种方式注定无法支持所有AE特性，因为有很多的AE效果在有桌面显卡的情况下，都要走一个进度条才能预览，在移动端是没有可能做到实时渲染的。这也导致在实际的生产过程中，设计师有很多的复杂动画效果，都无法用矢量模式导出出来，这样会极大限制设计师的创意发挥。</p>
<p>另外一方面，在矢量的导出模式下，同样一个动画效果，设计师采用不同的制作方式，会产生截然不同的性能表现。设计师虽然可以利用我们配套的性能检测工具去不断优化到极致，但是越复杂的效果，要花费的优化时间也越多。对于视频模板这种注重视觉效果并且需要批量化生产的场景，纯矢量导出很难满足需求。这里我们就想到了传统的序列帧导出方式。它是基于截图的原理，性能只跟分辨率有关，天然的不需要设计师花时间去优化，只需要关注视觉效果即可。但是它的缺点也比较明显，运行时无法编辑，文件也相对较大。PAG方案在这里的创新点就是将两者的进行了完美整合，支持矢量和序列帧的混合导出。设计可以主动标记哪些图层使用序列帧导出，例如不需要编辑并且有复杂的动效，而需要编辑的图层继续用简单的矢量方式导出。从而实现支持所有的AE特性又能保持运行时的编辑性。</p>
<h2><a class="anchor" aria-hidden="true" id="二bmp预合成"></a><a href="#二bmp预合成" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>二、BMP预合成</h2>
<p>我们在PAG 2.0版本里引入了「BMP预合成」的概念，设计师只需要对指定的预合成名字加上 _bmp后缀就可以实现局部图层的截图导出。在确定了要引入序列帧导出模式后，剩下的挑战就是使用什么格式来存储导出的序列帧。相比传统的图片序列帧，「BMP预合成」使用了视频序列帧的格式存储，可以充分利用起极限的帧间压缩能力，轻松压缩到图片序列帧百分之一点几的大小。</p>
<p><img 
  src='https://pagio-1251316161.file.myqcloud.com/website/static/img/docs/tech/bmp_data.jpeg' 
  style='width: 600px; margin: 32px 0 48px 0' 
/></p>
<hr>
<p>上表是各种序列帧方案文件大小的对比。APNG由于在PNG基础上做了简单的帧间压缩，只记录前一帧变化的区域，可以压缩到72.2%的大小。而这里的位图序列帧是我们在过渡时期的一种序列帧格式，它是在APNG的帧间压缩能力上结合了WebP改造出来的，压缩率也比较不错，平均可以做到5.53%。它主要的问题是分辨率大时CPU占用率较高，目前已经不怎么使用。而视频序列帧最小，平均可以压缩到1.24%左右，比位图序列帧还小78%。另外视频的格式还可以在运行时利用硬件加速的解码，可以几乎不占CPU，从而获得更高的渲染性能。但视频格式也有一个明显的缺点，就是不支持透明通道。目前业内在扩展视频透明通道上已经有了成熟的解决方案。</p>
<p><img 
  src='https://pagio-1251316161.file.myqcloud.com/website/static/img/docs/tech/bmp_realize.jpeg' 
  style='width: 600px; margin: 32px 0 48px 0' 
/></p>
<hr>
<p>就是将一张RGBA的图片扩展成两倍大小的不透明图片，左边放置RGB的内容，右边放置表示Alpha的灰度图。然后再将这张不透明图片拿去编码，最后渲染时再合并回RGBA的图片。这里我们在业内方案的基础上还加了一些兼容性改进：PAG导出的视频画面并不总是左右排列的，还有可能上下排列。因为实际解码环境中，部分设备不支持解码画面比例过长的视频。我们的导出插件会尽可能让它接近一个方形。而在渲染的过程中，由于启用了硬件加速解码，可以直接得到一个YUV的纹理。我们在这里的优化点主要是不使用常见的FFmpeg来执行YUV到RGB转换，从而避免纹理在CPU和GPU之间来回拷贝。而是自定义了一个Shader脚本，利用硬件加速在一次绘制过程中，同时完成YUV转换和Alpha通道合并。这里平均就能够提高10%的渲染性能。</p>
<h2><a class="anchor" aria-hidden="true" id="三数据容器封装realize"></a><a href="#三数据容器封装realize" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>三、数据容器封装realize</h2>
<p><img 
  src='https://pagio-1251316161.file.myqcloud.com/website/static/img/docs/tech/bmp_struct.jpeg' 
  style='width: 600px; margin: 32px 0 48px 0' 
/></p>
<hr>
<p>解决了单个视频帧的导出和渲染后，我们还要考虑上层的数据封装格式，也就是如何存储这些视频帧。PAG并没有使用标准的MP4容器作为视频帧的封装，而是设计了一个简化的数据结构。比较直接的原因是使用MP4容器，会增加我们导出的文件大小，额外还要依赖外部的库来解封装，也会增加我们的包大小。</p>
<p>另外定制的数据结构也可以优化渲染性能。第一个方面在动画场景下，可以理解为每次刷新都是随机Seek。例如外部使用的帧率跟我们不一致时，就会以固定间隔跳跃式的播放。要解决这个随机Seek的性能问题，核心点就需要数据结构能一次返回所有的关键帧列表，而不需要额外的查询操作。然后执行一个非常高效的算法，每次刷新都向前查找第一个遇到的关键帧，或者上次解码过的帧号，从那个位置开始解码到当前位置即可。另外一方面，视频序列帧虽然是视频，但是它本质上还是代表了一个动画。因此就存在前面提到过的静态区间。PAG的导出插件会自动在静态区间交接处设置关键帧，并且把静态区间信息存储到我们设计的数据结构内。而这些处于静态区间的视频帧，虽然不影响导出的文件大小，但是提交给硬件解码器还是会存在固定的等待延迟。这里我们可以利用静态区间信息直接返回上次解码的内容，而跳过这部分等待。</p>
<video id="video" controls="" preload="none" width="400" style='margin: 24px 0; border-radius: 8px' poster="https://pagio-1251316161.file.myqcloud.com/website/static/img/docs/tech/bmp.png">
   <source id="mp4" src="https://pagio-1251316161.file.myqcloud.com/website/static/video/bmp.mp4" type="video/mp4">
</video>
<p>极限情况下，例如上面这个俄罗斯方块的视频模板，每个方块虽然都是一个静态图层，但是使用了矢量不支持的效果，因此就会导出一个全时长都是静态区间的视频序列帧，这种情况也是比较常见的。而通过刚刚的优化，能够将渲染耗时从1088.4ms优化到7.5ms，提升99.3%的性能。</p>
<hr>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/pag-depth-1.html"><span class="arrow-prev">← </span><span>PAG深度解读（一）：编辑架构演进</span></a><a class="docs-next button" href="/docs/pag-depth-3.html"><span>PAG深度解读（三）：高效动画文件</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#一矢量序列帧混合导出">一、矢量+序列帧混合导出</a></li><li><a href="#二bmp预合成">二、BMP预合成</a></li><li><a href="#三数据容器封装realize">三、数据容器封装realize</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="copyright">Copyright © 2022 pag.io</section></footer></div></body></html>