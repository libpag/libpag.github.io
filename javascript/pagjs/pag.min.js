/**
* PAG.js v1.0.2
* (c) 2022 akazenoslin
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).PAG={})}(this,(function(t){"use strict";var e,i;(i=e||(e={}))[i.InputError=0]="InputError",i[i.LoadFileByXhrError=1]="LoadFileByXhrError",i[i.LoadFileNotResponse=2]="LoadFileNotResponse",i[i.ReadPagFileError=3]="ReadPagFileError",i[i.PagFileLengthErrorTooShort=4]="PagFileLengthErrorTooShort",i[i.InvalidPagFileHeader=5]="InvalidPagFileHeader",i[i.NotByteArray=6]="NotByteArray",i[i.PagCodecError=7]="PagCodecError",i[i.ReadStartCodeError=8]="ReadStartCodeError",i[i.NotPagFile=9]="NotPagFile",i[i.NotVideoData=10]="NotVideoData",i[i.NotMp4File=11]="NotMp4File",i[i.NotSequence=12]="NotSequence",i[i.NotNalu=13]="NotNalu",i[i.NotFrames=14]="NotFrames",i[i.NotPayloadOnRemuxer=15]="NotPayloadOnRemuxer",i[i.NotSupportMSE=16]="NotSupportMSE",i[i.NotSupportMultipleSequence=17]="NotSupportMultipleSequence",i[i.PagDestroyed=18]="PagDestroyed",i[i.InvalidPercentage=19]="InvalidPercentage",i[i.WriteFileFile=20]="WriteFileFile";const s={0:"\u8bf7URL\u6216\u8005\u4e0a\u4f20\u7684PAG\u6587\u4ef6\u662f\u5426\u6b63\u786e\uff01",1:"\u52a0\u8f7dPAG\u6587\u4ef6\u7f51\u7edc\u8bf7\u6c42\u9519\u8bef\uff01",2:"\u52a0\u8f7dPAG\u6587\u4ef6\u5185\u5bb9\u4e3a\u7a7a!",3:"\u8bfb\u53d6PAG\u6587\u4ef6\u9519\u8bef\uff01",4:"PAG\u6587\u4ef6\u957f\u5ea6\u592a\u77ed!",5:"\u65e0\u6548\u7684PAG\u6587\u4ef6\u5934\u90e8!",6:"\u6587\u4ef6\u4e2d\u5b57\u8282\u6d41\u4e0d\u5b58\u5728!",7:"PAG\u89e3\u7801\u9519\u8bef!",8:"\u8bfb\u53d6StartCode\u9519\u8bef!",9:"PAG\u6587\u4ef6\u4e0d\u5b58\u5728\uff01",10:"VideoData\u4e0d\u5b58\u5728\uff01",11:"MP4\u6587\u4ef6\u4e0d\u5b58\u5728\uff01",12:"\u89c6\u9891\u5e8f\u5217\u5e27\u4e0d\u5b58\u5728\uff01",13:"\u89c6\u9891\u5e8f\u5217\u5e27\u4e0aNalu\u4e0d\u5b58\u5728\uff01",14:"\u89c6\u9891\u5e8f\u5217\u5e27\u4e0aFrame\u4e0d\u5b58\u5728\uff01",15:"Remuxer\u4e0a\u4e0d\u5b58\u5728Payload\uff01",16:"\u6d4f\u89c8\u5668\u4e0d\u652f\u6301MediaSourceExtension\uff01",17:"\u6682\u4e0d\u652f\u6301\u591asequence\u7684PAG\u6587\u4ef6\uff01",18:"\u8be5PAG\u5df2\u7ecf\u9500\u6bc1\uff01",19:"\u65e0\u6548\u767e\u5206\u6bd4!",20:"\u5199\u5165\u6587\u4ef6\u5931\u8d25"};class r{static log(t){console.log(t)}static error(t){throw new Error(s[t])}}var o,n,a,h;(n=o||(o={}))[n.Unknown=0]="Unknown",n[n.Vector=1]="Vector",n[n.Bitmap=2]="Bitmap",n[n.Video=3]="Video",(h=a||(a={}))[h.End=0]="End",h[h.FontTables=1]="FontTables",h[h.VectorCompositionBlock=2]="VectorCompositionBlock",h[h.CompositionAttributes=3]="CompositionAttributes",h[h.ImageTables=4]="ImageTables",h[h.LayerBlock=5]="LayerBlock",h[h.LayerAttributes=6]="LayerAttributes",h[h.SolidColor=7]="SolidColor",h[h.TextSource=8]="TextSource",h[h.TextPathOption=9]="TextPathOption",h[h.TextMoreOption=10]="TextMoreOption",h[h.ImageReference=11]="ImageReference",h[h.CompositionReference=12]="CompositionReference",h[h.Transform2D=13]="Transform2D",h[h.MaskBlock=14]="MaskBlock",h[h.ShapeGroup=15]="ShapeGroup",h[h.Rectangle=16]="Rectangle",h[h.Ellipse=17]="Ellipse",h[h.PolyStar=18]="PolyStar",h[h.ShapePath=19]="ShapePath",h[h.Fill=20]="Fill",h[h.Stroke=21]="Stroke",h[h.GradientFill=22]="GradientFill",h[h.GradientStroke=23]="GradientStroke",h[h.MergePaths=24]="MergePaths",h[h.TrimPaths=25]="TrimPaths",h[h.Repeater=26]="Repeater",h[h.RoundCorners=27]="RoundCorners",h[h.Performance=28]="Performance",h[h.DropShadowStyle=29]="DropShadowStyle",h[h.InnerShadowStyle=30]="InnerShadowStyle",h[h.OuterGlowStyle=31]="OuterGlowStyle",h[h.InnerGlowStyle=32]="InnerGlowStyle",h[h.BevelAndEmbossStyle=33]="BevelAndEmbossStyle",h[h.SatinStyle=34]="SatinStyle",h[h.ColorOverlayStyle=35]="ColorOverlayStyle",h[h.GradientOverlayStyle=36]="GradientOverlayStyle",h[h.StrokeStyle=37]="StrokeStyle",h[h.TintEffect=38]="TintEffect",h[h.FillEffect=39]="FillEffect",h[h.StrokeEffect=40]="StrokeEffect",h[h.TritoneEffect=41]="TritoneEffect",h[h.DropShadowEffect=42]="DropShadowEffect",h[h.RadialWipeEffect=43]="RadialWipeEffect",h[h.DisplacementMapEffect=44]="DisplacementMapEffect",h[h.BitmapCompositionBlock=45]="BitmapCompositionBlock",h[h.BitmapSequence=46]="BitmapSequence",h[h.ImageBytes=47]="ImageBytes",h[h.ImageBytes2=48]="ImageBytes2",h[h.ImageBytes3=49]="ImageBytes3",h[h.VideoCompositionBlock=50]="VideoCompositionBlock",h[h.VideoSequence=51]="VideoSequence",h[h.LayerAttributesV2=52]="LayerAttributesV2",h[h.Count=53]="Count";const d=t=>{const e=t.readUint16();let i=(63&e)>>>0;const s=e>>6;return 63===i&&(i=t.readUint32()),t.context.tagLevel<s&&(t.context.tagLevel=s),{code:s,length:i}};function l(t,e,i){let s=d(t);for(;s.code!==a.End;){const r=t.readBytes(s.length);i(r,s.code,e),t.context.tagLevel<r.context.tagLevel&&(t.context.tagLevel=r.context.tagLevel),s=d(t)}}var c,u,p,g,m,f,y,v;(u=c||(c={}))[u.Normal=0]="Normal",u[u.Multiply=1]="Multiply",u[u.Screen=2]="Screen",u[u.Overlay=3]="Overlay",u[u.Darken=4]="Darken",u[u.Lighten=5]="Lighten",u[u.ColorDodge=6]="ColorDodge",u[u.ColorBurn=7]="ColorBurn",u[u.HardLight=8]="HardLight",u[u.SoftLight=9]="SoftLight",u[u.Difference=10]="Difference",u[u.Exclusion=11]="Exclusion",u[u.Hue=12]="Hue",u[u.Saturation=13]="Saturation",u[u.Color=14]="Color",u[u.Luminosity=15]="Luminosity",u[u.DestinationIn=21]="DestinationIn",u[u.DestinationOut=22]="DestinationOut",u[u.DestinationATop=23]="DestinationATop",u[u.SourceIn=24]="SourceIn",u[u.SourceOut=25]="SourceOut",u[u.Xor=26]="Xor",(g=p||(p={}))[g.MoveTo=0]="MoveTo",g[g.LineTo=1]="LineTo",g[g.CurveTo=2]="CurveTo",g[g.Close=3]="Close",(f=m||(m={}))[f.None=0]="None",f[f.Linear=1]="Linear",f[f.Bezier=2]="Bezier",f[f.Hold=3]="Hold",(v=y||(y={}))[v.LeftJustify=0]="LeftJustify",v[v.CenterJustify=1]="CenterJustify",v[v.RightJustify=2]="RightJustify",v[v.FullJustifyLastLineLeft=3]="FullJustifyLastLineLeft",v[v.FullJustifyLastLineRight=4]="FullJustifyLastLineRight",v[v.FullJustifyLastLineCenter=5]="FullJustifyLastLineCenter",v[v.FullJustifyLastLineFull=6]="FullJustifyLastLineFull";const w={red:0,green:0,blue:0},b={red:255,green:255,blue:255},x=()=>{r.log("PAG Verify Failed!")},S=t=>!!t||(r.log("PAG Verify Failed!"),!1),A=class{constructor(){this.id=0,this.width=0,this.height=0,this.duration=0,this.frameRate=30,this.backgroundColor=b,this.cacheID=0,this.cacheID=A.cacheIDCount,A.cacheIDCount+=1}type(){return o.Unknown}getStaticTimeRanges(){}verify(){return S(this.width>0&&this.height>0&&this.duration>0&&this.frameRate>0)}};let E=A;E.cacheIDCount=1;class T extends E{constructor(){super(...arguments),this.hasAlpha=!1,this.sequences=[],this.staticTimeRanges=[],this.staticTimeRangeUpdated=!1}type(){return o.Video}getStaticTimeRanges(){return this.staticTimeRangeUpdated||(this.staticTimeRangeUpdated=!0,this.updateStaticTimeRanges()),this.staticTimeRanges}updateStaticTimeRanges(){if(!(this.duration<=1))if(this.sequences.length>0){let t=this.sequences[0];for(let e=1;e<this.sequences.length;e++){const i=this.sequences[e];i.frameRate>t.frameRate&&(t=i)}const e=this.frameRate/t.frameRate;for(const i of t.staticTimeRanges)i.start=Math.round(i.start*e),i.end=Math.round(i.end*e),this.staticTimeRanges.push(i)}else{const t={start:0,end:this.duration-1};this.staticTimeRanges.push(t)}}hasImageContent(){return!0}verify(){if(!super.verify()||this.sequences.length<=0)return x(),!1;for(const t of this.sequences)if(!t||!t.verify())return x(),!1;return!0}}class C{constructor(t,e){this.numerator=1,this.denominator=1,this.numerator=t,this.denominator=e}value(){return this.numerator/this.denominator}}const R=new C(1,1);class P{constructor(t,e){this.x=t,this.y=e}}const U=new P(0,0);var L,k,B,V,F,I,M,D;(k=L||(L={}))[k.Unknown=0]="Unknown",k[k.DropShadow=1]="DropShadow",k[k.Stroke=2]="Stroke",(V=B||(B={}))[V.None=0]="None",V[V.Alpha=1]="Alpha",V[V.AlphaInverted=2]="AlphaInverted",V[V.Luma=3]="Luma",V[V.LumaInverted=4]="LumaInverted",(I=F||(F={}))[I.Unknown=0]="Unknown",I[I[void 0]=1]="undefined",I[I.Solid=2]="Solid",I[I.Text=3]="Text",I[I.Shape=4]="Shape",I[I.Image=5]="Image",I[I.PreCompose=6]="PreCompose";class W{constructor(){this.id=0,this.parent=void 0,this.containingComposition=void 0,this.stretch=R,this.startTime=0,this.duration=0,this.autoOrientation=!1,this.transform=void 0,this.isActive=!0,this.blendMode=c.Normal,this.trackMatteType=0,this.trackMatteLayer=void 0,this.timeRemap=void 0,this.masks=void 0,this.effects=void 0,this.layerStyles=void 0,this.layerCache=void 0,this.maxScale=void 0}type(){return 0}excludeVaryingRanges(t){if(this.transform.excludeVaryingRanges(t),void 0!==this.timeRemap&&this.timeRemap.excludeVaryingRanges(t),void 0!==this.masks)for(const e of this.masks)e.excludeVaryingRanges(t);if(void 0!==this.effects&&this.effects.length>0)for(const e of this.effects)e.excludeVaryingRanges(t);if(void 0!==this.layerStyles&&this.layerStyles.length>0)for(const e of this.layerStyles)e.excludeVaryingRanges(t)}gotoFrame(t){if(this.transform.gotoFrame(t),void 0!==this.timeRemap&&this.timeRemap.gotoFrame(t),void 0!==this.masks&&this.masks.length>0)for(const e of this.masks)e.gotoFrame(t);if(void 0!==this.effects&&this.effects.length>0)for(const e of this.effects)e.gotoFrame(t);if(void 0!==this.layerStyles&&this.layerStyles.length>0)for(const e of this.layerStyles)e.gotoFrame(t)}verify(){if(!this.containingComposition||this.duration<=0||!this.transform)return x(),!1;if(!this.transform.verify())return x(),!1;if(this.masks&&this.masks.length>0)for(const t of this.masks)if(!t||!t.verify())return x(),!1;if(this.layerStyles&&this.layerStyles.length>0)for(const t of this.layerStyles)if(!t||!t.verify())return x(),!1;if(this.effects&&this.effects.length>0)for(const t of this.effects)if(!t||!t.verify())return x(),!1;return!0}getMaxScaleFactor(){if(void 0!==this.maxScale)return this.maxScale;this.maxScale=new P(1,1);const t=this.transform.scale;if(t.animatable()){const{keyframes:e}=t;let i=Math.abs(e[0].startValue.x),s=Math.abs(e[0].startValue.y);if(void 0!==e&&e.length>0)for(const t of e){const e=Math.abs(t.endValue.x),r=Math.abs(t.endValue.y);i<e&&(i=e),s<r&&(s=r)}this.maxScale.x=i,this.maxScale.y=s}else this.maxScale.x=Math.abs(t.value.x),this.maxScale.y=Math.abs(t.value.y);if(void 0!==this.parent){const t=this.parent.getMaxScaleFactor();this.maxScale.x*=t.x,this.maxScale.y*=t.y}return this.maxScale}}(D=M||(M={}))[D.None=0]="None",D[D.Add=1]="Add",D[D.Subtract=2]="Subtract",D[D.Intersect=3]="Intersect",D[D.Lighten=4]="Lighten",D[D.Darken=5]="Darken",D[D.Difference=6]="Difference",D[D.Accum=7]="Accum";const N=.005,_=t=>({red:t.readUint8(),green:t.readUint8(),blue:t.readUint8()}),G=t=>t.readEncodedUint64(),q=t=>{const e=t.readFloat32(),i=t.readFloat32();return new P(e,i)},O=(t,e)=>{e.width=t.readEncodeInt32(),e.height=t.readEncodeInt32(),e.duration=G(t),e.frameRate=t.readFloat32(),e.backgroundColor=_(t)};class H{constructor(){this.isKeyframe=!1,this.frame=0,this.fileBytes=void 0}}class z extends class{constructor(){this.composition=void 0,this.id=0,this.width=0,this.height=0,this.frameRate=0,this.frameCount=0,this.isKeyFrameFlags=[]}verify(){return S(void 0!==this.composition&&this.width>0&&this.height>0&&this.frameRate>0)}}{constructor(){super(...arguments),this.alphaStartX=0,this.alphaStartY=0,this.frames=[],this.headers=[],this.staticTimeRanges=[]}verify(){if(!super.verify()||this.frames.length<=0)return x(),!1;for(const t of this.frames)if(!t&&!t.fileBytes)return x(),!1;for(const t of this.headers)if(!t)return x(),!1;return!0}}class X{constructor(t,e){this.data=void 0,this.length=0,this.data=t,this.length=e}}class K{constructor(){this.tagLevel=0,this.compositions=[],this.images=[],this.errorMessages=[]}throwException(t){this.errorMessages.push(t)}releaseCompositions(){const t=this.compositions.slice();return this.compositions=void 0,t}releaseImages(){const t=this.images.slice();return this.images=void 0,t}}var Y=Math.pow;class J{constructor(t,e){this.position=0,this.bitPosition=0,this.dataView=new DataView(t),this.littleEndian=!!e,this.context=new K}get length(){return this.dataView.byteLength}get bytesAvailable(){return this.dataView.byteLength-this.position}data(){return this.dataView.buffer}get postion(){return this.position}alignWithBytes(){this.bitPosition=8*this.position}readBoolean(){const t=this.dataView.getInt8(this.position);return this.position+=1,this.positonChangend(),Boolean(t)}readChar(){this.position>=this.length&&r.error(e.PagCodecError);const t=this.dataView.getInt8(this.position);return this.position+=1,this.positonChangend(),String.fromCharCode(t)}readUint8(){this.position>=this.length&&r.error(e.PagCodecError);const t=this.dataView.getUint8(this.position);return this.position+=1,this.positonChangend(),t}readInt8(){this.position>=this.length&&r.error(e.PagCodecError);const t=this.dataView.getInt8(this.position);return this.position+=1,this.positonChangend(),t}readInt16(){this.position>=this.length-1&&r.error(e.PagCodecError);const t=this.dataView.getInt16(this.position,this.littleEndian);return this.position+=2,this.positonChangend(),t}readUint16(){this.position>=this.length-1&&r.error(e.PagCodecError);const t=this.dataView.getUint16(this.position,this.littleEndian);return this.position+=2,this.positonChangend(),t}readInt24(){this.position>=this.length-2&&r.error(e.PagCodecError);const t=this.dataView.getInt16(this.position,this.littleEndian),i=this.dataView.getInt8(this.position+2);return this.position+=3,this.positonChangend(),this.littleEndian?t+Y(2,16)*i:Y(2,16)*t+i}readUint24(){this.position>=this.length-2&&r.error(e.PagCodecError);const t=this.dataView.getUint16(this.position,this.littleEndian),i=this.dataView.getUint8(this.position+2);return this.position+=3,this.positonChangend(),this.littleEndian?t+Y(2,16)*i:Y(2,16)*t+i}readInt32(){this.position>=this.length-3&&r.error(e.PagCodecError);const t=this.dataView.getInt32(this.position,this.littleEndian);return this.position+=4,this.positonChangend(),t}readUint32(){this.position>=this.length-3&&r.error(e.PagCodecError);const t=this.dataView.getUint32(this.position,this.littleEndian);return this.position+=4,this.positonChangend(),t}readInt64(){this.position>=this.length-7&&r.error(e.PagCodecError);const t=this.dataView.getInt32(this.position,this.littleEndian),i=this.dataView.getInt32(this.position+4,this.littleEndian);return this.position+=8,this.positonChangend(),this.littleEndian?t+Y(2,32)*i:Y(2,32)*t+i}readUint64(){this.position>=this.length-7&&r.error(e.PagCodecError);const t=this.dataView.getUint32(this.position,this.littleEndian),i=this.dataView.getUint32(this.position+4,this.littleEndian);return this.position+=8,this.positonChangend(),this.littleEndian?t+Y(2,32)*i:Y(2,32)*t+i}readFloat32(){this.position>=this.length-3&&r.error(e.PagCodecError);const t=this.dataView.getFloat32(this.position,this.littleEndian);return this.position+=4,this.positonChangend(),t}readDouble(){this.position>=this.length-7&&r.error(e.PagCodecError);const t=this.dataView.getFloat64(this.position,this.littleEndian);return this.position+=8,this.positonChangend(),t}readUTF8String(){this.position>=this.length&&r.error(e.PagCodecError);let t="",i=0;for(let e=this.position;e<this.length&&0!==this.dataView.getUint8(e);e++)t+=`%${this.dataView.getUint8(e).toString(16)}`,i+=1;return this.position+=i,this.positonChangend(),decodeURIComponent(t)}readEncodedUint32(){let t=0,e=0;for(let i=0;i<32;i+=7){if(this.position>=this.length)throw Error("readEncodedUint32 End of file was encountered.");if(e=this.dataView.getUint8(this.position),this.position+=1,t|=(127&e)<<i,0==(128&e))break}return this.positonChangend(),t}readEncodeInt32(){const t=this.readEncodedUint32(),e=t>>1;return(1&t)>0?-e:e}readEncodedUint64(){let t=0,e=0;for(let i=0;i<64;i+=7){if(this.position>=this.length)throw Error("readEncodedUint64 End of file was encountered.");if(e=this.dataView.getUint8(this.position),this.position+=1,t|=(127&e)<<i,0==(128&e))break}return this.positonChangend(),t}readEncodeInt64(){const t=this.readEncodedUint64(),e=t<<0;return(1&t)>0?-e:e}readBytes(t){(!t||t<=0)&&(t=this.length-this.position),this.position>this.length-t&&r.error(e.PagCodecError);const i=this.dataView.buffer.slice(this.position,this.position+t);return this.position+=t,this.positonChangend(),new J(i,this.littleEndian)}readUBits(t){const i=[0,1,3,7,15,31,63,127,255];let s=0;this.bitPosition>8*this.length-t&&r.error(e.PagCodecError);let o=0;for(;o<t;){const e=Math.floor(.125*this.bitPosition),r=this.bitPosition%8;let n=this.dataView.getUint8(e)>>r;const a=Math.min(8-r,t-o);n&=i[a],s|=n<<o,o+=a,this.bitPosition+=a}return this.bitPositionChanged(),s}readBits(t){let e=this.readUBits(t);e<<=32-t;return e<<0>>32-t}readNumBits(){return this.readUBits(5)+1}readInt32List(t){const e=this.readNumBits(),i=new Array(t);for(let s=0;s<t;s++)i[s]=this.readBits(e);return i}readUint32List(t){const e=this.readNumBits(),i=new Array(t);for(let s=0;s<t;s++)i[s]=this.readUBits(e);return i}readBitBoolean(){return 0!==this.readUBits(1)}readFloatList(t,e){const i=this.readNumBits(),s=new Array(t);for(let r=0;r<t;r++)s[r]=this.readBits(i)*e;return s}bitPositionChanged(){this.position=Math.ceil(.125*this.bitPosition)}positonChangend(){this.bitPosition=8*this.position}}const $=t=>{let e=0;for(const i of t)e+=i.byteLength;const i=new Uint8Array(e);let s=0;for(const e of t)i.set(e,s),s+=e.byteLength;return i},j=t=>{const i=t.readEncodedUint32(),s=t.readBytes(i);0===i&&r.error(e.ReadStartCodeError);const o=new ArrayBuffer(i+4);((t,e,i,s,r)=>{if(e>=t.byteLength||s>=i.byteLength||i.byteLength-s>t.byteLength-e||r>i.byteLength)return;const o=new Uint8Array(t),n=new Uint8Array(i,s,r);o.set(n,e)})(o,4,s.data(),0,i);const n=new DataView(o);return n.setUint8(0,0),n.setUint8(1,0),n.setUint8(2,0),n.setUint8(3,1),new X(new J(o),i+4)},Z=(t,e,i)=>{const{composition:s}=i;switch(e){case a.CompositionAttributes:O(t,s);break;case a.VideoSequence:{const e=((t,e)=>{const i=new z;i.width=t.readEncodeInt32(),i.height=t.readEncodeInt32(),i.frameRate=t.readFloat32(),e&&(i.alphaStartX=t.readEncodeInt32(),i.alphaStartY=t.readEncodeInt32());const s=j(t),r=j(t);i.headers.push(s,r),i.frameCount=t.readEncodedUint32();for(let e=0;e<i.frameCount;e++){const e=new H;e.isKeyframe=t.readBitBoolean(),i.frames.push(e)}for(let e=0;e<i.frameCount;e++){const s=i.frames[e];s.frame=G(t),s.fileBytes=j(t)}if(t.bytesAvailable>0){const e=t.readEncodedUint32();for(let s=0;s<e;s++){const e={start:0,end:0};e.start=G(t),e.end=G(t),i.staticTimeRanges.push(e)}}return i})(t,i.hasAlpha);e.composition=s,s.sequences.push(e);break}}};var Q,tt,et,it;function st(t,e,i){if(i<e)return;for(let s=t.length-1;s>=0;s--){const r=t[s];if(!(r.end<e||r.start>i)){if(r.start<e&&r.end>i){const o={start:i+1,end:r.end};r.end=e-1,o.end>o.start&&t.splice(s+1,0,o),r.end<=r.start&&t.splice(s,1);break}r.start>=e&&r.end<=i?t.splice(s,1):r.start<e?(r.end=e-1,r.end<=r.start&&t.splice(s,1)):(r.start=i+1,r.end<=r.start&&t.splice(s,1))}}}function rt(t,e){for(let i=t.length-1;i>=0;i--){const s=t[i];if(s.start===e||s.end<=e)break;if(s.start<e&&s.end>e){const r={start:e,end:s.end};s.end=e-1,r.end>r.start&&t.splice(i+1,0,r),s.end<=s.start&&t.splice(i,1);break}}}(tt=Q||(Q={}))[tt.Unknown=0]="Unknown",tt[tt.Tint=1]="Tint",tt[tt.Fill=2]="Fill",tt[tt.Stroke=3]="Stroke",tt[tt.Tritone=4]="Tritone",tt[tt.DropShadow=5]="DropShadow",tt[tt.RadialWipe=6]="RadialWipe",tt[tt.DisplacementMap=7]="DisplacementMap";class ot extends E{constructor(){super(...arguments),this.layers=[],this.staticTimeRanges=[],this.staticTimeRangeUpdated=!1}type(){return o.Vector}getStaticTimeRanges(){return this.staticTimeRangeUpdated||(this.staticTimeRangeUpdated=!0,this.updateStaticTimeRanges()),this.staticTimeRanges}verify(){if(!super.verify())return x(),!1;for(const t of this.layers)if(!t||!t.verify())return x(),!1;return!0}updateStaticTimeRanges(){if(this.duration>1){const t={start:0,end:this.duration-1};this.staticTimeRanges=[t];for(const t of this.layers){if(this.staticTimeRanges.length<=0)break;t.excludeVaryingRanges(this.staticTimeRanges),rt(this.staticTimeRanges,t.startTime),rt(this.staticTimeRanges,t.startTime+t.duration)}}}}class nt{animatable(){return!1}excludeVaryingRanges(t){}gotoFrame(t){}}class at{constructor(){this.anchorPoint=void 0,this.position=void 0,this.xPosition=void 0,this.yPosition=void 0,this.scale=void 0,this.rotation=void 0,this.opacity=void 0}static createDefaultTransform2D(){const t=new at;return t.anchorPoint=new nt,t.anchorPoint.value=U,t.position=new nt,t.position.value=U,t.xPosition=new nt,t.xPosition.value=0,t.yPosition=new nt,t.yPosition.value=0,t.scale=new nt,t.scale.value=new P(1,1),t.rotation=new nt,t.rotation.value=0,t.opacity=new nt,t.opacity.value=255,t}excludeVaryingRanges(t){this.anchorPoint.excludeVaryingRanges(t),void 0!==this.position?this.position.excludeVaryingRanges(t):(this.xPosition.excludeVaryingRanges(t),this.yPosition.excludeVaryingRanges(t)),this.scale.excludeVaryingRanges(t),this.rotation.excludeVaryingRanges(t),this.opacity.excludeVaryingRanges(t)}gotoFrame(t){this.anchorPoint.gotoFrame(t),void 0!==this.position?this.position.gotoFrame(t):(this.xPosition.gotoFrame(t),this.yPosition.gotoFrame(t)),this.scale.gotoFrame(t),this.rotation.gotoFrame(t),this.opacity.gotoFrame(t)}verify(){return void 0!==this.anchorPoint&&(void 0!==this.position||void 0!==this.xPosition&&void 0!==this.yPosition)&&void 0!==this.scale&&void 0!==this.rotation&&void 0!==this.opacity}}class ht extends W{constructor(){super(...arguments),this.composition=void 0,this.compositionStartTime=0,this.staticTimeRanges=void 0,this.staticTimeRangeUpdated=!1}static wrap(t){const e=new ht;e.duration=t.duration;const i=new at;return i.anchorPoint=new nt,i.anchorPoint.value=U,i.position=new nt,i.position.value=U,i.scale=new nt,i.scale.value=new P(1,1),i.rotation=new nt,i.rotation.value=0,i.opacity=new nt,i.opacity.value=255,e.transform=i,e.composition=t,e}type(){return F.PreCompose}excludeVaryingRanges(t){super.excludeVaryingRanges(t),t&&0!==t.length&&this.updateStaticTimeRanges()}gotoFrame(t){super.gotoFrame(t)}verify(){return!!super.verify()&&!!this.composition}updateStaticTimeRanges(){if(this.staticTimeRangeUpdated)return;this.staticTimeRangeUpdated=!0;const t=this.composition.getStaticTimeRanges();for(let e=t.length-1;e>=0;e--){const i=t[e];i.start+=this.compositionStartTime,i.end+=this.compositionStartTime,i.end<=this.startTime?t.pop():i.start<this.startTime?i.start=0:i.start>=this.startTime+this.duration-1?t.pop():i.end>this.startTime+this.duration-1&&(i.end=this.startTime+this.duration-1)}this.staticTimeRanges=t}}class dt extends W{constructor(){super(...arguments),this.contents=[]}type(){return F.Shape}excludeVaryingRanges(t){super.excludeVaryingRanges(t);for(const e of this.contents)e.excludeVaryingRanges(t)}gotoFrame(t){super.gotoFrame(t);for(const e of this.contents)e.gotoFrame(t)}verify(){if(!super.verify())return!1;for(const t of this.contents)if(void 0===t||!t.verify())return!1;return!0}}class lt extends W{constructor(){super(...arguments),this.solidColor=w,this.width=0,this.height=0}type(){return F.Solid}excludeVaryingRanges(t){super.excludeVaryingRanges(t)}gotoFrame(t){super.gotoFrame(t)}verify(){return super.verify()?S(this.width>0&&this.height>0):(x(),!1)}}class ct extends W{type(){return F.undefined}}class ut{constructor(){this.startTime=0,this.endTime=0,this.interpolationType=m.Hold,this.bezierOut=[],this.bezierIn=[],this.spatialOut=U,this.spatialIn=U}initialize(){}getValue(t){return this.startValue}containsTime(t){return t>=this.startTime&&t<this.endTime}}class pt extends nt{constructor(t){super(),this.keyframes=t,this.lastKeyframeIndex=0,void 0!==t&&t.length>0&&(this.value=t[0].startValue);for(const e of t)e.initialize()}animatable(){return!0}excludeVaryingRanges(t){for(const e of this.keyframes)switch(e.interpolationType){case m.Bezier:case m.Linear:st(t,e.startTime,e.endTime-1);break;default:rt(t,e.startTime),rt(t,e.endTime)}}gotoFrame(t){let e=this.keyframes[this.lastKeyframeIndex];if(e.containsTime(t))this.value=e.getValue(t);else{if(t<e.startTime)for(;this.lastKeyframeIndex>0&&(this.lastKeyframeIndex-=1,!this.keyframes[this.lastKeyframeIndex].containsTime(t)););else for(;this.lastKeyframeIndex<this.keyframes.length-1&&(this.lastKeyframeIndex+=1,!this.keyframes[this.lastKeyframeIndex].containsTime(t)););e=this.keyframes[this.lastKeyframeIndex],t<=e.startTime?this.value=e.startValue:t>=e.endTime?this.value=e.endValue:this.value=e.getValue(t)}}}(it=et||(et={}))[it.Value=0]="Value",it[it.FixedValue=1]="FixedValue",it[it.SimpleProperty=2]="SimpleProperty",it[it.DiscreteProperty=3]="DiscreteProperty",it[it.MultiDimensionProperty=4]="MultiDimensionProperty",it[it.SpatialProperty=5]="SpatialProperty",it[it.BitFlag=6]="BitFlag",it[it.Custom=7]="Custom";const gt=(t,e,i)=>{const s=i,r=[];if(!s.configs||0===s.configs.length)return e;for(const e of s.configs){const i=wt(t,e);r.push(i)}t.alignWithBytes();let o=0;for(const i of s.configs){const s=r[o],n=i.key;i.readAttribute(t,s,e,n),o+=1}return e};class mt{constructor(t,e,i){this.attributeType=e,this.defaultValue=i,this.key=t}readAttribute(t,e,i,s){}readValue(t){}readValueList(t,e,i){}dimensionality(){return 1}newKeyframe(t){return new ut}}const ft=(t,e,i,s,r)=>{6===r.attributeType?i[s]=e.exist:1===r.attributeType?i[s]=r.readValue(t):0===r.attributeType?i[s]=vt(t,r,e):i[s]=yt(t,r,e)},yt=(t,e,i)=>{let s;if(i.exist)if(i.animatable){const r=bt(t,e,i);if(!r||0===r.length)throw"Wrong number of keyframes.";xt(t,r,e),St(t,r,e),i.hasSpatial,s=new pt(r)}else s=new nt,s.value=vt(t,e,i);else s=new nt,s.value=e.defaultValue;return s},vt=(t,e,i)=>i.exist?e.readValue(t):e.defaultValue,wt=(t,e)=>{const i={exist:!1,animatable:!1,hasSpatial:!1},{attributeType:s}=e;return 1===s?(i.exist=!0,i):(i.exist=t.readBitBoolean(),i.exist&&0!==s&&6!==s&&7!==s?(i.animatable=t.readBitBoolean(),i.animatable&&5===s?(i.hasSpatial=t.readBitBoolean(),i):i):i)},bt=(t,e,i)=>{const s=[],r=t.readEncodedUint32();for(let o=0;o<r;o++){let r;if(3===e.attributeType)r=new ut;else{const s=t.readUBits(2);s===m.Hold?r=new ut:(r=e.newKeyframe(i),r.interpolationType=s)}s.push(r)}return s},xt=(t,e,i)=>{const s=e.length;e[0].startTime=G(t);for(let i=0;i<s;i++){const r=G(t);e[i].endTime=r,i<s-1&&(e[i+1].startTime=r)}const r=[];i.readValueList(t,r,s+1);let o=0;e[0].startValue=r[o],o+=1;for(let t=0;t<s;t++){const i=r[o];o+=1,e[t].endValue=i,t<s-1&&(e[t+1].startValue=i)}},St=(t,e,i)=>{const s=4===i.attributeType?i.dimensionality():1,r=t.readNumBits();for(const i of e){if(i.interpolationType!==m.Bezier)continue;let e,o;for(let n=0;n<s;n++)e=t.readBits(r)*N,o=t.readBits(r)*N,i.bezierOut.push({x:e,y:o}),e=t.readBits(r)*N,o=t.readBits(r)*N,i.bezierIn.push({x:e,y:o})}};function At(t,e,i){return t+(e-t)*i}class Et{getInterpolation(t){return t}}class Tt extends ut{constructor(){super(...arguments),this.xInterpolator=void 0,this.yInterpolator=void 0}initialize(){super.initialize(),this.interpolationType===m.Bezier||(this.xInterpolator=new Et,this.yInterpolator=new Et)}getValue(t){const e=(t-this.startTime)/(this.endTime-this.startTime),i=this.xInterpolator.getInterpolation(e),s=this.yInterpolator.getInterpolation(e);return{x:At(this.startValue.x,this.endValue.x,i),y:At(this.startValue.y,this.endValue.y,s)}}}class Ct extends ut{constructor(){super(...arguments),this.interpolator=void 0}initialize(){this.interpolationType===m.Bezier||(this.interpolator=new Et)}getProgress(t){const e=(t-this.startTime)/(this.endTime-this.startTime);return this.interpolator.getInterpolation(e)}getValue(t){const e=this.getProgress(t);return At(this.startValue,this.endValue,e)}}class Rt extends mt{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,s){ft(t,e,i,s,this)}readValue(t){return t.readFloat32()}readValueList(t,e,i){for(let s=0;s<i;s++)e.push(this.readValue(t))}dimensionality(){return 1}newKeyframe(t){return new Ct}}class Pt extends mt{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,s){ft(t,e,i,s,this)}readValue(t){return t.readBoolean()}readValueList(t,e,i){for(let s=0;s<i;s++)e.push(t.readBitBoolean())}dimensionality(){return 1}newKeyframe(t){return new ut}}class Ut extends mt{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,s){ft(t,e,i,s,this)}readValue(t){return t.readUint8()}readValueList(t,e,i){const s=t.readUint32List(i);for(let t=0;t<i;t++)e.push(s[t])}dimensionality(){return 1}newKeyframe(t){return new Ct}}class Lt extends mt{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,s){ft(t,e,i,s,this)}readValue(t){return G(t)}readValueList(t,e,i){for(let s=0;s<i;s++)e[s]=this.readValue(t)}dimensionality(){return 1}newKeyframe(t){return new Ct}}class kt extends mt{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,s){ft(t,e,i,s,this)}readValue(t){return q(t)}readValueList(t,e,i){if(this.attributeType===et.SpatialProperty){const s=t.readFloatList(2*i,.05);for(let t=0;t<i;t++)e[t]||(e[t]=new P(0,0)),e[t].x=s[t]}else for(let s=0;s<i;s++)e[s]=q(t)}dimensionality(){return 2}newKeyframe(t){switch(this.attributeType){case et.MultiDimensionProperty:return new Tt;default:return new Ct}}}class Bt extends mt{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,s){ft(t,e,i,s,this)}readValue(t){return(t=>{const e=t.readEncodeInt32(),i=t.readEncodedUint32();return new C(e,i)})(t)}readValueList(t,e,i){for(let s=0;s<i;s++)e[s]=this.readValue(t)}dimensionality(){return 1}newKeyframe(t){return new Ct}}class Vt extends mt{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,s){ft(t,e,i,s,this)}readValue(t){return(t=>{const e=t.readEncodedUint32();if(e>0){const t=new W;return t.id=e,t}})(t)}readValueList(t,e,i){for(let s=0;s<i;s++)e[s]=this.readValue(t)}dimensionality(){return 1}newKeyframe(t){return new Ct}}const Ft={tagCode:a.LayerAttributes,configs:[new Pt("isActive",et.BitFlag,!0),new Pt("autoOrientation",et.BitFlag,!1),new Vt("parent",et.Value,void 0),new Bt("stretch",et.Value,R),new Lt("startTime",et.Value,0),new Ut("blendMode",et.Value,c.Normal),new Ut("trackMatteType",et.Value,B.None),new Rt("timeRemap",et.SimpleProperty,0),new Lt("duration",et.FixedValue,0)]},It={tagCode:a.LayerAttributesV2,configs:[new Pt("isActive",et.BitFlag,!0),new Pt("autoOrientation",et.BitFlag,!1),new Vt("parent",et.Value,void 0),new Bt("stretch",et.Value,R),new Lt("startTime",et.Value,0),new Ut("blendMode",et.Value,c.Normal),new Ut("trackMatteType",et.Value,B.None),new Rt("timeRemap",et.SimpleProperty,0),new Lt("duration",et.FixedValue,0),new class extends mt{constructor(t,e,i){super(t,e,i)}readAttribute(t,e,i,s){ft(t,e,i,s,this)}readValue(t){return t.readUTF8String()}readValueList(t,e,i){for(let s=0;s<i;s++)e[s]=this.readValue(t)}dimensionality(){return 1}newKeyframe(t){return new Ct}}("name",et.Value,"")]},Mt={tagCode:a.Transform2D,configs:[new kt("anchorPoint",et.SpatialProperty,U),new kt("position",et.SpatialProperty,U),new Rt("xPosition",et.SimpleProperty,0),new Rt("yPosition",et.SimpleProperty,0),new kt("scale",et.MultiDimensionProperty,new P(1,1)),new Rt("rotation",et.SimpleProperty,0),new Ut("opacity",et.SimpleProperty,255)]};a.MaskBlock;const Dt=(t,e,i)=>{switch(e){case a.LayerAttributes:gt(t,i,Ft),i.duration<=0&&(i.duration=1);break;case a.LayerAttributesV2:gt(t,i,It),i.duration<=0&&(i.duration=1);break;case a.Transform2D:i.transform=new at,gt(t,i.transform,Mt),i.transform.position.animatable()||i.transform.position.value!==U||!i.transform.xPosition.animatable()&&0===i.transform.xPosition.value&&!i.transform.yPosition.animatable()&&0===i.transform.yPosition.value?(i.transform.xPosition=void 0,i.transform.yPosition=void 0):i.transform.position=void 0;break;case a.SolidColor:i.type()===F.Solid&&function(t,e){e.solidColor=_(t),e.width=t.readEncodeInt32(),e.height=t.readEncodeInt32()}(t,i);break;case a.CompositionReference:i.type()===F.PreCompose&&function(t,e){const i=t.readEncodedUint32();i>0&&(e.composition=new E,e.composition.id=i),e.compositionStartTime=G(t)}(t,i)}},Wt=(t,e,i)=>{switch(e){case a.CompositionAttributes:O(t,i);break;case a.LayerBlock:i.layers.push((t=>{let e;switch(t.readUint8()){case F.undefined:e=new ct;break;case F.Solid:e=new lt;break;case F.Shape:e=new dt;break;case F.PreCompose:e=new ht;break;default:e=new W}return e.id=t.readEncodedUint32(),l(t,e,Dt),e})(t))}},Nt=t=>{if(!t||0===t.length)return;const e=new Map;for(const i of t)i&&(_t(i),e.set(i.id,i));let i=0;for(const s of t)if(s){if(void 0!==s.parent){const t=s.parent.id,i=e.get(t);void 0!==i&&(s.parent=i)}if(i>0&&Gt(s.trackMatteType)&&(s.trackMatteLayer=t[i-1]),void 0!==s.effects&&s.effects.length>0)for(const t of s.effects)t&&(t.type(),Q.DisplacementMap);i+=1}},_t=t=>{if(!t||!t.masks||0===t.masks.length)return;const e=new Map;for(const i of t.masks)i&&e.set(i.id,i);if(void 0!==t.effects&&t.effects.length>0)for(const i of t.effects)if(i){if(void 0!==i.maskReferences&&i.maskReferences.length>0){const t=new Array;for(const s of i.maskReferences){const i=s.id,r=e.get(i);void 0!==r&&t.push(r)}i.maskReferences=t}switch(i.type()){case Q.Fill:if(void 0!==i.fillMask){const t=i.fillMask.id,s=e.get(t);void 0!==s&&(i.fillMask=s)}break;case Q.Stroke:{const t=i;if(t.path=void 0){const i=t.path.id,s=e.get(i);void 0!==s&&(t.path=s)}break}}}if(t.type()===F.Text){const{pathOption:i}=t;if(null==i?void 0:i.path){const t=i.path.id,s=e.get(t);void 0!==s&&(i.path=s)}}},Gt=t=>{switch(t){case B.Alpha:case B.AlphaInverted:return!0;default:return!1}};function qt(t,e,i){switch(e){case a.VectorCompositionBlock:i.compositions.push((t=>{const e=new ot;return e.id=t.readEncodedUint32(),l(t,e,Wt),Nt(e.layers),e})(t));break;case a.VideoCompositionBlock:i.compositions.push((t=>{const e=new T;return e.id=t.readEncodedUint32(),e.hasAlpha=t.readBoolean(),l(t,{composition:e,hasAlpha:e.hasAlpha},Z),e})(t))}}class Ot{constructor(){this.matrix={width:0,height:0,frameRate:0,duration:0,hasAlpha:!1,transform:new at,videoWidth:0,videoHeight:0}}static create(t){t||r.error(e.NotPagFile);const i=new Ot;return t.mainComposition.type()===o.Video?i.getVideoDataFromVideoComposition(t.mainComposition):t.mainComposition.type()===o.Vector&&i.getVideoDataFromVectorComposition(t.mainComposition),i}getH264Raw(){this.sequence||r.error(e.NotSequence);return(t=>{const e=t.map((t=>new Uint8Array(t)));return $(e)})([...this.sequence.headers.map((t=>t.data.data())),...this.sequence.frames.map((t=>t.fileBytes.data.data()))])}getPTS(){if(!this.sequence)return;return this.sequence.frames.map((t=>t.frame))}getVideoDataFromVideoComposition(t){t.sequences.length<1&&r.error(e.NotSequence),this.matrix.width=t.width,this.matrix.height=t.height,this.matrix.frameRate=t.frameRate,this.matrix.duration=t.duration,this.matrix.videoWidth=t.width,this.matrix.videoHeight=t.height,this.matrix.hasAlpha=!!t.hasAlpha;const i=t.sequences[t.sequences.length-1];this.sequence=i,this.matrix.transform=at.createDefaultTransform2D()}getVideoDataFromVectorComposition(t){let i=0;for(const s of t.layers){if(s.type()!==F.PreCompose)continue;const t=s.composition;t.type()===o.Video&&t.sequences.length>=1&&(i+=1),i>1&&r.error(e.NotSupportMultipleSequence)}i<1&&r.error(e.NotSequence),this.matrix.width=t.width,this.matrix.height=t.height,this.matrix.frameRate=t.frameRate,this.matrix.duration=t.duration;for(const e of t.layers){if(e.type()!==F.PreCompose)continue;const t=e.composition;if(t.type()!==o.Video&&t.sequences.length<1)continue;this.matrix.videoWidth=t.width,this.matrix.videoHeight=t.height,this.matrix.hasAlpha=!!t.hasAlpha;const i=t.sequences[t.sequences.length-1];this.sequence=i,this.matrix.transform=e.transform;break}}}const Ht=class{static get TYPES(){return{[Ht.idr]:"IDR",[Ht.sei]:"SEI",[Ht.sps]:"SPS",[Ht.pps]:"PPS",[Ht.ndr]:"NDR",[Ht.aud]:"AUD"}}static getNaluType(t){return t.nalUnitType in Ht.TYPES?Ht.TYPES[t.nalUnitType]:"UNKNOWN"}constructor(t){this.payload=t,this.nalRefIdc=(96&this.payload[0])>>5,this.nalUnitType=31&this.payload[0],this.isVcl=1===this.nalUnitType||5===this.nalUnitType,this.sliceType=0,this.firstMbInSlice=!1}toString(){return`${Ht.TYPES[this.nalUnitType]}: NRI: ${this.nalRefIdc}`}isKeyframe(){return this.nalUnitType===Ht.idr}getPayloadSize(){return this.payload.byteLength}getSize(){return 4+this.getPayloadSize()}getData(){const t=new Uint8Array(this.getSize());return new DataView(t.buffer).setUint32(0,this.getSize()-4),t.set(this.payload,4),t}};let zt=Ht;zt.ndr=1,zt.idr=5,zt.sei=6,zt.sps=7,zt.pps=8,zt.aud=9;class Xt{constructor(t){this.data=t,this.index=0,this.bitLength=8*t.byteLength}get bitsAvailable(){return this.bitLength-this.index}skipBits(t){if(this.bitsAvailable<t)return!1;this.index+=t}readBits(t,e=!0){return this.getBits(t,this.index,e)}skipLZ(){let t;for(t=0;t<this.bitLength-this.index;++t)if(0!==this.getBits(1,this.index+t,!1))return this.index+=t,t;return t}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const t=this.skipLZ();return this.readBits(t+1)-1}readEG(){const t=this.readUEG();return 1&t?1+t>>>1:-1*(t>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(t=1){return this.readBits(8*t)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}readUE(){let t=0,e=0;for(;0===this.readBits(1)&&e<32&&this.bitsAvailable;)e+=1;return t=this.readBits(e),t+=(1<<e)-1,t}getBits(t,e,i=!0){if(this.bitsAvailable<t)return 0;const s=e%8,r=this.data[e/8|0]&255>>>s,o=8-s;if(o>=t)return i&&(this.index+=t),r>>o-t;i&&(this.index+=o);const n=t-o;return r<<n|this.getBits(n,e+o,i)}}class Kt{static getNaluFromSequence(t){return[...t.headers.map((t=>new Uint8Array(t.data.data(),4))),...t.frames.map((t=>new Uint8Array(t.fileBytes.data.data(),4)))]}static getH264Frames(t){t.length<1&&r.error(e.NotNalu);const i=[];let s=[],o=!1,n=!1;for(const e of t){const t=new zt(e);t.nalUnitType!==zt.idr&&t.nalUnitType!==zt.ndr||Kt.parseHeader(t),s.length&&n&&(t.firstMbInSlice||!t.isVcl)&&(i.push({units:s,isKeyFrame:o}),s=[],o=!1,n=!1),s.push(t),o=o||t.isKeyframe(),n=n||t.isVcl}if(s.length>0)if(n)i.push({units:s,isKeyFrame:o});else{const t=i.length-1;i[t].units=i[t].units.concat(s)}return i}static parseHeader(t){const e=new Xt(t.payload);e.readUByte(),t.firstMbInSlice=0===e.readUEG(),t.sliceType=e.readUEG()}static parseSPS(t){const{width:e,height:i}=Kt.readSPS(t),s=new Uint8Array(t);let r="avc1.";const o=new DataView(t.buffer,t.byteOffset+1,4);for(let t=0;t<3;++t){let e=o.getUint8(t).toString(16);e.length<2&&(e=`0${e}`),r+=e}return{sps:s,codec:r,width:e,height:i}}static skipScalingList(t,e){let i,s=8,r=8;for(let o=0;o<e;o++)0!==r&&(i=t.readEG(),r=(s+i+256)%256),s=0===r?s:r}static readSPS(t){const e=new Xt(t);let i,s,r=0,o=0,n=0,a=0,h=1;e.readBits(1),e.readBits(2),e.readBits(5);const d=e.readUByte();if(e.readBits(6),e.readBits(2),e.readUByte(),e.readUE(),[100,110,122,244,44,83,86,118,128].indexOf(d)>-1){const t=e.readUE();3===t&&e.skipBits(1),e.readUE(),e.readUE(),e.skipBits(1);if(e.readBoolean()){s=3!==t?8:12;for(let t=0;t<s;++t)e.readBoolean()&&(t<6?Kt.skipScalingList(e,16):Kt.skipScalingList(e,64))}}e.readUE();const l=e.readUE();if(0===l)e.readUE();else if(1===l){e.skipBits(1),e.readUE(),e.readUE(),i=e.readUE();for(let t=0;t<i;++t)e.readUE()}e.readUE(),e.skipBits(1);const c=e.readUE(),u=e.readUE(),p=e.readBits(1);0===p&&e.skipBits(1),e.readBits(1);e.readBoolean()&&(r=e.readUE(),o=e.readUE(),n=e.readUE(),a=e.readUE());if(e.readBoolean()){if(e.readBoolean()){let t;switch(e.readUByte()){case 1:t=[1,1];break;case 2:t=[12,11];break;case 3:t=[10,11];break;case 4:t=[16,11];break;case 5:t=[40,33];break;case 6:t=[24,11];break;case 7:t=[20,11];break;case 8:t=[32,11];break;case 9:t=[80,33];break;case 10:t=[18,11];break;case 11:t=[15,11];break;case 12:t=[64,33];break;case 13:t=[160,99];break;case 14:t=[4,3];break;case 15:t=[3,2];break;case 16:t=[2,1];break;case 255:t=[e.readUByte()<<8|e.readUByte(),e.readUByte()<<8|e.readUByte()]}t&&(h=t[0]/t[1])}}return{width:Math.ceil((16*(c+1)-2*r-2*o)*h),height:(2-p)*(u+1)*16-(p?2:4)*(n+a)}}}const Yt=2082873600,Jt=t=>[t>>24,t>>16&255,t>>8&255,255&t],$t=t=>[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)],jt=class{constructor(){this.types={avc1:[],avcC:[],btrt:[],ctts:[],dinf:[],dref:[],edts:[],elst:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],stss:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},Object.keys(this.types).forEach((t=>{Object.prototype.hasOwnProperty.call(this.types,t)&&(this.types[t]=$t(t))}));const t=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]);this.dinf=jt.box(this.types.dinf,jt.box(this.types.dref,t))}static box(t,...e){let i=8,s=e.length;const r=s;for(;s;)s-=1,i+=e[s].byteLength;const o=new Uint8Array(i);for(o[0]=i>>24&255,o[1]=i>>16&255,o[2]=i>>8&255,o[3]=255&i,o.set(t,4),s=0,i=8;s<r;++s)o.set(e[s],i),i+=e[s].byteLength;return o}ftyp(){return jt.box(this.types.ftyp,new Uint8Array($t("isom")),new Uint8Array([0,0,0,1]),new Uint8Array($t("isom")),new Uint8Array($t("iso2")),new Uint8Array($t("avc1")),new Uint8Array($t("mp41")))}moov(t,e,i){let s=t.length;const r=[];for(;s;)s-=1,r[s]=this.trak(t[s]);return jt.box.apply(null,[this.types.moov,this.mvhd(i,e)].concat(r).concat(this.mvex(t)))}moof(t,e,i){return jt.box(this.types.moof,this.mfhd(t),this.traf(e,i))}mdat(t){return jt.box(this.types.mdat,t)}hdlr(t){return jt.box(this.types.hdlr,jt.hdlrTypes[t])}mdhd(t){return jt.box(this.types.mdhd,new Uint8Array([0,0,0,0,...Jt(Math.floor(Date.now()/1e3+Yt)),...Jt(Math.floor(Date.now()/1e3+Yt)),...Jt(t.timescale),...Jt(0),85,196,0,0]))}mdia(t){return jt.box(this.types.mdia,this.mdhd(t),this.hdlr(t.type),this.minf(t))}mfhd(t){return jt.box(this.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t]))}minf(t){return"audio"===t.type?jt.box(this.types.minf,jt.box(this.types.smhd,jt.smhd),this.dinf,this.stbl(t)):jt.box(this.types.minf,jt.box(this.types.vmhd,jt.vmhd),this.dinf,this.stbl(t))}mvex(t){let e=t.length;const i=[];for(;e;)e-=1,i[e]=this.trex(t[e]);return jt.box.apply(null,[this.types.mvex].concat(i))}mvhd(t,e){const i=new Uint8Array([0,0,0,0,...Jt(Math.floor(Date.now()/1e3+Yt)),...Jt(Math.floor(Date.now()/1e3+Yt)),...Jt(t),...Jt(e),0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2]);return jt.box(this.types.mvhd,i)}sdtp(t){const e=t.samples||[],i=new Uint8Array(4+e.length);let s,r;for(r=0;r<e.length;r++)s=e[r].flags,i[r+4]=s.dependsOn<<4|s.isDependedOn<<2|s.hasRedundancy;return jt.box(this.types.sdtp,i)}stbl(t){return jt.box(this.types.stbl,this.stsd(t),this.stts(t),this.ctts(t),this.stss(t),jt.box(this.types.stsc,jt.stsc),jt.box(this.types.stsz,jt.stsz),jt.box(this.types.stco,jt.stco))}avc1(t){let e,i,s,r=[],o=[];for(e=0;e<t.sps.length;e++)i=t.sps[e],s=i.byteLength,r.push(s>>>8&255),r.push(255&s),r=r.concat(Array.prototype.slice.call(i));for(e=0;e<t.pps.length;e++)i=t.pps[e],s=i.byteLength,o.push(s>>>8&255),o.push(255&s),o=o.concat(Array.prototype.slice.call(i));const n=jt.box(this.types.avcC,new Uint8Array([1,r[3],r[4],r[5],255,224|t.sps.length].concat(r).concat([t.pps.length]).concat(o))),{width:a}=t,{height:h}=t;return jt.box(this.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,a>>8&255,255&a,h>>8&255,255&h,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,98,105,110,101,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255]),n)}esds(t){const e=t.config.byteLength,i=new Uint8Array(26+e+3);return i.set([0,0,0,0,3,23+e,0,1,0,4,15+e,64,21,0,0,0,0,0,0,0,0,0,0,0,5,e]),i.set(t.config,26),i.set([6,1,2],26+e),i}mp4a(t){const{audiosamplerate:e}=t;return jt.box(this.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,e>>8&255,255&e,0,0]),jt.box(this.types.esds,this.esds(t)))}stsd(t){return"audio"===t.type?jt.box(this.types.stsd,jt.stsd,this.mp4a(t)):jt.box(this.types.stsd,jt.stsd,this.avc1(t))}tkhd(t){return jt.box(this.types.tkhd,new Uint8Array([0,0,0,1,...Jt(Math.floor(Date.now()/1e3+Yt)),...Jt(Math.floor(Date.now()/1e3+Yt)),...Jt(t.id),0,0,0,0,...Jt(t.duration),0,0,0,0,0,0,0,0,0,0,0,0,t.volume>>0&255,t.volume%1*10>>0&255,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,t.width>>8&255,255&t.width,0,0,t.height>>8&255,255&t.height,0,0]))}traf(t,e){const i=this.sdtp(e),{id:s}=e;return jt.box(this.types.traf,jt.box(this.types.tfhd,new Uint8Array([0,0,0,0,s>>24,s>>16&255,s>>8&255,255&s])),jt.box(this.types.tfdt,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t])),this.trun(e,i.length+16+16+8+16+8+8),i)}trak(t){return t.duration=t.duration||4294967295,jt.box(this.types.trak,this.tkhd(t),this.edts(t),this.mdia(t))}edts(t){return jt.box(this.types.edts,this.elst(t))}elst(t){const e=t.samples.length,i=Math.floor(t.duration/e),s=[0,0,0,0,...Jt(1),...Jt(t.duration),...Jt(t.implicitOffset*i),0,1,0,0];return jt.box(this.types.elst,new Uint8Array(s))}trex(t){const{id:e}=t;return jt.box(this.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}trun(t,e){const i=t.samples||[],s=i.length,r=12+16*s,o=new Uint8Array(r);let n,a,h,d,l,c;for(e+=8+r,o.set([0,0,15,1,s>>>24&255,s>>>16&255,s>>>8&255,255&s,e>>>24&255,e>>>16&255,e>>>8&255,255&e],0),n=0;n<s;n++)a=i[n],h=a.duration,d=a.size,l=a.flags,c=a.cts,o.set([h>>>24&255,h>>>16&255,h>>>8&255,255&h,d>>>24&255,d>>>16&255,d>>>8&255,255&d,l.isLeading<<2|l.dependsOn,l.isDependedOn<<6|l.hasRedundancy<<4|l.paddingValue<<1|l.isNonSync,61440&l.degradPrio,15&l.degradPrio,c>>>24&255,c>>>16&255,c>>>8&255,255&c],12+16*n);return jt.box(this.types.trun,o)}stts(t){const e=t.samples.length,i=Math.floor(t.duration/e),s=[0,0,0,0,...Jt(1),...Jt(e),...Jt(i)];return jt.box(this.types.stts,new Uint8Array(s))}ctts(t){const e=t.pts.length,i=Math.floor(t.duration/e),s=[0,0,0,0,...Jt(e)];for(let r=0;r<e;r++){s.push(...Jt(1));const e=r*i,o=t.pts[r]*i+t.implicitOffset*i;s.push(...Jt(o-e))}return jt.box(this.types.ctts,new Uint8Array(s))}stss(t){const e=t.samples.filter((t=>t.flags.isKeyFrame)).map((t=>t.index+1)),i=[0,0,0,0,...Jt(e.length)];for(const t of e)i.push(...Jt(t));return jt.box(this.types.stss,new Uint8Array(i))}};let Zt=jt;Zt.hdlrTypes={video:new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),audio:new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0])},Zt.fullbox=new Uint8Array([0,0,0,0,0,0,0,0]),Zt.stsc=jt.fullbox,Zt.stco=jt.fullbox,Zt.stsz=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),Zt.vmhd=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),Zt.smhd=new Uint8Array([0,0,0,0,0,0,0,0]),Zt.stsd=new Uint8Array([0,0,0,0,0,0,0,1]);const Qt=[zt.sps,zt.pps,zt.idr,zt.ndr];let te=1;class ee{constructor(){this.mp4track={id:ee.getTrackID(),type:"video",len:0,fragmented:!0,sps:void 0,pps:void 0,width:0,height:0,timescale:0,duration:0,samples:[],pts:[],codec:"",fps:0,implicitOffset:0},this.samples=[]}static getTrackID(){const t=te;return te+=1,t}static remux(t,i){t.length<1&&r.error(e.NotFrames);const s=new ee;s.mp4track.timescale=6e3,s.mp4track.duration=Math.floor(t.length/i.matrix.frameRate*6e3),s.mp4track.fps=i.matrix.frameRate,s.mp4track.pts=i.getPTS(),s.mp4track.implicitOffset=ie(s.mp4track.pts);let o=!1;for(const e of t){const t=e.units.filter((t=>Qt.includes(t.nalUnitType)));if(t.length<1)continue;const i=t.reduce(((t,e)=>t+e.getSize()),0);s.mp4track.sps||(t.forEach((t=>{if(t.nalUnitType===zt.sps){const{sps:e,codec:i,width:r,height:o}=Kt.parseSPS(t.payload);s.mp4track.width=r,s.mp4track.height=o,s.mp4track.sps=[e],s.mp4track.codec=i}})),s.mp4track.sps&&s.mp4track.pps&&(o=!0)),s.mp4track.pps||(t.forEach((t=>{t.nalUnitType===zt.pps&&(s.mp4track.pps=[new Uint8Array(t.payload)])})),s.mp4track.sps&&s.mp4track.pps&&(o=!0)),o&&(s.mp4track.len+=i,s.samples.push({units:t,size:i,keyFrame:e.isKeyFrame}))}return s}convertMp4(){const t=this.getPayload();if(!t)return;const e=new Zt,i=e.ftyp(),s=e.moov([this.mp4track],this.mp4track.duration,this.mp4track.timescale),r=e.moof(1,0,this.mp4track),o=e.mdat(t);return $([i,s,r,o])}getPayload(){const t=new Uint8Array(this.mp4track.len),e=Math.floor(this.mp4track.duration/this.samples.length);let i=0,s=0;for(const r of this.samples){const{units:o}=r,n={index:s,size:r.size,duration:e,cts:this.mp4track.pts[s]*e+this.mp4track.implicitOffset*e-s*e,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,isNonSync:r.keyFrame?0:1,dependsOn:r.keyFrame?2:1,isKeyFrame:r.keyFrame}};for(const e of o)t.set(e.getData(),i),i+=e.getSize();this.mp4track.samples.push(n),s+=1}if(this.mp4track.samples.length)return t}}const ie=t=>{const e=t.map(((t,e)=>t-e)).filter((t=>t<0));return e.length<1?0:Math.abs(Math.min(...e))};class se{static generatorMP4(t){const e=Kt.getNaluFromSequence(t.sequence),i=Kt.getH264Frames(e),s=ee.remux(i,t);return{matrix:t.matrix,sequenceInfo:{width:t.sequence.width,height:t.sequence.height,frameCount:t.sequence.frameCount,alphaStartX:t.sequence.alphaStartX,alphaStartY:t.sequence.alphaStartY},mp4Info:{width:s.mp4track.width,height:s.mp4track.height},data:s.convertMp4()}}}var re,oe,ne,ae,he,de;class le{constructor(t,e){this.tagLevel=1,this.compositions=[],this.numLayers=0,this.images=[],this.scaledTimeRange={start:0,end:0},this.mainComposition=t[t.length-1],this.scaledTimeRange.start=0,this.scaledTimeRange.end=this.mainComposition.duration,this.compositions=t,this.images=e,this.duration=this.mainComposition.duration,this.implDuration=1e3*this.mainComposition.duration/this.mainComposition.frameRate;for(const e of t)if(e.type()===o.Vector)for(const t of e.layers)t.type()!==F.PreCompose&&(this.numLayers+=1);else this.numLayers+=1}static loadFile(t){return i=this,s=null,o=function*(){let i;"string"==typeof t&&""!==t?i=yield this.loadFileByXHR(t):t instanceof File&&(t=>/(?:pag)$/.test(t.name))(t)?i=t:r.error(e.InputError);const s=yield this.readFileAsPAGFile(i),o=le.pagFile2videoData(s);return se.generatorMP4(o)},new Promise(((t,e)=>{var r=t=>{try{a(o.next(t))}catch(t){e(t)}},n=t=>{try{a(o.throw(t))}catch(t){e(t)}},a=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,n);a((o=o.apply(i,s)).next())}));var i,s,o}static loadFileByXHR(t){return new Promise((i=>{!function(t){if("[object Object]"!==String(t))return;const e=Object.assign(t);e.method=t.method?t.method.toUpperCase():"GET",e.data=t.data||{};let i="";const s=Object.keys(e.data).map((t=>`${t}=${e.data[t]}`));i=s.join("&"),"GET"===e.method&&s.length>0&&(e.url+=0===location.search.length?"".concat("?",i):"".concat("&",i));const r=new XMLHttpRequest;r.responseType=e.responseType,r.onreadystatechange=()=>{4===r.readyState&&(200===r.status?e.success&&"function"==typeof e.success&&e.success(r.response):e.error&&"function"==typeof e.error&&e.error(r.onerror))},r.open(e.method,e.url,!0),"POST"===e.method&&r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.send("POST"===e.method?i:void 0)}({url:t,method:"GET",responseType:"blob",success:s=>{s||r.error(e.LoadFileNotResponse);const o=new window.File([s],t.replace(/(.*\/)*([^.]+)/i,"$2"));i(o)},error:()=>{r.error(e.LoadFileByXhrError)}})}))}static readFileAsPAGFile(t){return new Promise((i=>{const s=new FileReader;s.onload=()=>{const t=s.result,n=new J(t,!0),{compositions:h,images:d,tagLevel:c}=class{static maxSupportedTagLevel(){return a.Count-1}static decode(t){t||r.error(e.NotByteArray);const i=this.readBodyBytes(t),{context:s}=i;l(i,s,qt),function(t){if(!t||0===t.length)return;const e=new Map;for(const i of t)i&&e.set(i.id,i);for(const i of t)if(i&&i.type()===o.Vector){const t=i;if(void 0!==t.layers&&t.layers.length>0)for(const i of t.layers){i.containingComposition=t;const s=i;if(s.type()===F.PreCompose&&void 0!==s.composition){const t=s.composition.id,i=e.get(t);void 0!==i&&(s.composition=i)}}}}(s.compositions);const{compositions:n,images:a}=((t,e)=>{let i=t.length>0;for(const e of t)if(!e||!e.verify()){i=!1;break}for(const t of e)if(!t||!t.verify()){i=!1;break}return i?{compositions:t,images:e}:(t=void 0,void(e=void 0))})(s.releaseCompositions(),s.releaseImages());return{compositions:n,images:a,tagLevel:s.tagLevel}}static readBodyBytes(t){t.length<11&&r.error(e.PagFileLengthErrorTooShort);const i=t.readInt8(),s=t.readInt8(),o=t.readInt8();return 80===i&&65===s&&71===o||r.error(e.InvalidPagFileHeader),t.readInt8(),t.readUint32(),t.readInt8(),t.readBytes()}}.decode(n),u=new le(h,d);u.tagLevel=c,i(u)},s.onerror=()=>{r.error(e.ReadPagFileError)},s.readAsArrayBuffer(t)}))}static pagFile2videoData(t){return Ot.create(t)}}(oe=re||(re={})).Canvas="Canvas",oe.WebGL="WebGL",(ae=ne||(ne={})).beforeFlush="beforeFlush",ae.afterFlush="afterFlush",ae.onAnimationStart="onAnimationStart",ae.onAnimationEnd="onAnimationEnd",ae.onAnimationCancel="onAnimationCancel",ae.onAnimationRepeat="onAnimationRepeat",(de=he||(he={})).None="None",de.Stretch="Stretch",de.LetterBox="LetterBox",de.Zoom="Zoom";const ce=(t,e,i)=>{const s=t.createProgram(),o=ue(t,e,t.VERTEX_SHADER),n=ue(t,i,t.FRAGMENT_SHADER);t.attachShader(s,o),t.attachShader(s,n),t.linkProgram(s);const a=t.getProgramInfoLog(s);a&&r.log(a);const h=t.getShaderInfoLog(o);h&&r.log(h);const d=t.getShaderInfoLog(n);return d&&r.log(d),s},ue=(t,e,i)=>{const s=t.createShader(i);return t.shaderSource(s,e),t.compileShader(s),s},pe=t=>t.replace(/^\s+|\s+$/g,""),ge="\n      attribute vec2 a_position;\n      attribute vec2 a_texCoord;\n      \n      uniform vec2 u_resolution;\n      uniform vec2 u_scale;\n      \n      varying vec2 v_texCoord;\n    \n      \n      void main() {\n         vec2 scaledPosition = a_position * u_scale;\n\n         // convert the rectangle from pixels to 0.0 to 1.0\n         vec2 zeroToOne = scaledPosition / u_resolution;\n      \n         // convert from 0->1 to 0->2\n         vec2 zeroToTwo = zeroToOne * 2.0;\n      \n         // convert from 0->2 to -1->+1 (clipspace)\n         vec2 clipSpace = zeroToTwo - 1.0;\n      \n         gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n      \n         // pass the texCoord to the fragment shader\n         // The GPU will interpolate this value between points.\n         v_texCoord = a_texCoord;\n      }\n        ";class me{constructor(){this.listenersMap={}}on(t,e){void 0===this.listenersMap[t]&&(this.listenersMap[t]=[]),this.listenersMap[t].push(e)}off(t,e){const i=this.listenersMap[t];if(void 0===i)return;if(void 0===e)return void delete this.listenersMap[t];const s=i.findIndex((t=>t===e));i.splice(s,1)}emit(t,...e){const i=this.listenersMap[t];if(void 0===i||i.length<1)return!1;for(const t of i)t(...e);return!0}}const fe=class{constructor(t,e,i){this.videoCanPlay=!1,this.positionLocation=0,this.texcoordLocation=0,this.renderTimer=null,this.playing=!1,this.destroyed=!1,this.repeatCount=0,this.viewportSize={x:0,y:0,width:0,height:0,scaleX:1,scaleY:1},this.canvas=e,i.disableHidpi||(e.style.width=`${e.width}px`,e.style.height=`${e.height}px`,e.width=e.width*window.devicePixelRatio,e.height=e.height*window.devicePixelRatio),this.mp4Data=t,this.renderingMode=i.renderingMode||re.WebGL,void 0!==i.repeatCount&&(this.repeatCount=i.repeatCount<0?-1:i.repeatCount-1)}static create(t,e,i){const s=new fe(t,e,i);s.supportWebGL=(()=>{const t=document.createElement("canvas");return!(!t.getContext("webgl")&&!t.getContext("experimental-webgl"))})(),s.videoAttributes=(t=>{const e={width:0,height:0,videoWidth:0,videoHeight:0,hasAlpha:!1,alphaStartX:0,alphaStartY:0,sequenceWidth:0,sequenceHeight:0,sequenceScale:{width:0,height:0},position:{x:0,y:0},mp4Width:0,mp4Height:0};return e.width=t.matrix.width,e.height=t.matrix.height,e.videoWidth=t.matrix.videoWidth,e.videoHeight=t.matrix.videoHeight,e.hasAlpha=t.matrix.hasAlpha,e.hasAlpha&&(e.alphaStartX=t.sequenceInfo.alphaStartX,e.alphaStartY=t.sequenceInfo.alphaStartY),e.sequenceWidth=t.sequenceInfo.width,e.sequenceHeight=t.sequenceInfo.height,e.sequenceScale={width:e.videoWidth/e.sequenceWidth,height:e.videoHeight/e.sequenceHeight},e.position={x:t.matrix.transform.position.value.x-t.matrix.transform.anchorPoint.value.x,y:t.matrix.transform.position.value.y-t.matrix.transform.anchorPoint.value.y},e})(s.mp4Data),s.eventManager=new me,s.videoEl=document.createElement("video"),s.videoEl.style.display="none",s.videoEl.muted=!0,s.videoEl.playsInline=!0;const r=new Blob([t.data],{type:"video/mp4"});return s.videoEl.addEventListener("canplay",(()=>{s.videoCanPlay=!0})),s.videoEl.src=URL.createObjectURL(r),t.mp4Info.width&&(s.videoAttributes.mp4Width=t.mp4Info.width),t.mp4Info.height&&(s.videoAttributes.mp4Height=t.mp4Info.height),s.videoEl.addEventListener("play",(()=>{s.flushLoop(s,s.videoEl)})),s.videoEl.addEventListener("pause",(()=>{s.clearRenderTimer()})),s.videoEl.addEventListener("ended",(()=>s.repeatCount<0?(s.videoEl.play(),void s.eventManager.emit("onAnimationRepeat")):0===s.repeatCount?(s.videoEl.currentTime=0,s.clearRenderTimer(),s.clearRender(),s.playing=!1,void s.eventManager.emit("onAnimationEnd")):(s.repeatCount-=1,s.videoEl.play(),void s.eventManager.emit("onAnimationRepeat")))),s.setRenderingMode(s.renderingMode),s.setScaleMode(i.scaleMode),s.renderingMode===re.WebGL&&s.loadWithWebGL(),s.renderingMode===re.Canvas&&s.loadWithCanvas(),s}play(){this.destroyed&&r.error(e.PagDestroyed),this.playing||(this.videoEl.play(),this.playing=!0,this.eventManager.emit("onAnimationStart"))}pause(){this.destroyed&&r.error(e.PagDestroyed),this.playing&&(this.videoEl.pause(),this.playing=!1,this.eventManager.emit("onAnimationCancel"))}stop(){this.destroyed&&r.error(e.PagDestroyed),this.videoEl.pause(),this.videoEl.currentTime=0,this.clearRender(),this.playing=!1,this.eventManager.emit("onAnimationCancel")}destroy(){this.destroyed||(this.stop(),this.canvas=null,this.videoEl=null,this.destroyed=!0)}isPlaying(){return this.playing}isDestroyed(){return this.destroyed}duration(){return this.videoEl.duration}setRepeatCount(t=1){this.repeatCount=t<0?-1:t-1}getProgress(){return Math.round(this.videoEl.currentTime/this.videoEl.duration*100)/100}setProgress(t){return this.destroyed&&r.error(e.PagDestroyed),(t<0||t>1)&&r.error(e.InvalidPercentage),this.playing&&this.pause(),this.videoEl.currentTime=t*this.videoEl.duration,new Promise((t=>{const e=()=>{this.flush(this.videoEl),this.videoEl.removeEventListener("timeupdate",e),t(!0)};this.videoEl.addEventListener("timeupdate",e)}))}flush(t){return!!this.videoCanPlay&&(this.eventManager.emit(ne.beforeFlush),this.renderingMode===re.WebGL?this.renderWithWebGL(t):this.renderWithCanvas(t),this.eventManager.emit(ne.afterFlush),!0)}addListener(t,e){return this.eventManager.on(t,e)}removeListener(t,e){return this.eventManager.off(t,e)}scaleMode(){return this.viewScaleMode}setScaleMode(t=he.LetterBox){switch(this.viewScaleMode=t,t){case he.None:this.viewportSize={x:this.videoAttributes.position.x,y:this.renderingMode===re.WebGL?this.gl.canvas.height-this.videoAttributes.position.y-this.videoAttributes.videoHeight:this.videoAttributes.position.y,width:this.videoAttributes.videoWidth,height:this.videoAttributes.videoHeight,scaleX:1,scaleY:1};break;case he.Stretch:{const t=this.canvas.width/this.videoAttributes.width,e=this.canvas.height/this.videoAttributes.height;this.viewportSize={x:this.videoAttributes.position.x*t,y:this.renderingMode===re.WebGL?this.canvas.height-this.videoAttributes.position.y*e-this.videoAttributes.videoHeight*e:this.videoAttributes.position.y*e,width:this.videoAttributes.videoWidth*t,height:this.videoAttributes.videoHeight*e,scaleX:t,scaleY:e}}break;case he.LetterBox:{const t=this.canvas.width/this.videoAttributes.width,e=this.canvas.height/this.videoAttributes.height,i=Math.min(t,e);this.viewportSize={x:(this.canvas.width-this.videoAttributes.width*i)/2+this.videoAttributes.position.x*i,y:this.renderingMode===re.WebGL?this.canvas.height-(this.canvas.height-this.videoAttributes.height*i)/2-this.videoAttributes.position.y*i-this.videoAttributes.videoHeight*i:(this.canvas.height-this.videoAttributes.height*i)/2+this.videoAttributes.position.y*i,width:this.videoAttributes.videoWidth*i,height:this.videoAttributes.videoHeight*i,scaleX:i,scaleY:i}}break;case he.Zoom:{const t=this.canvas.width/this.videoAttributes.width,e=this.canvas.height/this.videoAttributes.height,i=Math.max(t,e);this.viewportSize={x:(this.canvas.width-this.videoAttributes.width*i)/2+this.videoAttributes.position.x*i,y:this.renderingMode===re.WebGL?this.canvas.height-(this.canvas.height-this.videoAttributes.height*i)/2-this.videoAttributes.position.y*i-this.videoAttributes.videoHeight*i:(this.canvas.height-this.videoAttributes.height*i)/2+this.videoAttributes.position.y*i,width:this.videoAttributes.videoWidth*i,height:this.videoAttributes.videoHeight*i,scaleX:i,scaleY:i}}}}clearRender(){this.destroyed&&r.error(e.PagDestroyed),this.renderingMode===re.WebGL?this.clearRenderWithWebGL():this.clearRenderWithCanvas()}setRenderingMode(t){if(t===re.WebGL){if(!1===this.supportWebGL)return this.renderingMode=re.Canvas,void this.setRenderingMode(re.Canvas);this.gl||(this.gl=this.canvas.getContext("webgl",{})),this.gl?this.videoAttributes.hasAlpha?this.program=ce(this.gl,pe(ge),pe("\n      precision mediump float;\n      // our texture\n      uniform sampler2D u_image;\n      \n      // the texCoords passed in from the vertex shader.\n      varying vec2 v_texCoord;\n      uniform vec2 v_alphaStart;\n      \n      void main() {\n         vec4 color = texture2D(u_image, v_texCoord);\n         vec4 alpha = texture2D(u_image, vec2(v_texCoord.x + v_alphaStart.x, v_texCoord.y + v_alphaStart.y));\n         gl_FragColor = vec4(color.rgb * alpha.r, alpha.r);\n      }     \n         ")):this.program=ce(this.gl,pe(ge),pe("\n      precision mediump float;\n\n      // our texture\n      uniform sampler2D u_image;\n      \n      // the texCoords passed in from the vertex shader.\n      varying vec2 v_texCoord;\n      \n      void main() {\n         gl_FragColor = texture2D(u_image, v_texCoord);\n      }\n         ")):(this.renderingMode=re.Canvas,this.setRenderingMode(re.Canvas))}else this.context2D=this.canvas.getContext("2d")}loadWithWebGL(){if(this.positionLocation=this.gl.getAttribLocation(this.program,"a_position"),-1===this.positionLocation)throw new Error("unable to get attribute location for a_position");if(this.scaleLocation=this.gl.getUniformLocation(this.program,"u_scale"),-1===this.scaleLocation)throw new Error("unable to get attribute location for u_scale");if(this.texcoordLocation=this.gl.getAttribLocation(this.program,"a_texCoord"),-1===this.texcoordLocation)throw new Error("unable to get attribute location for a_texCoord");if(this.alphaStartLocation=this.gl.getUniformLocation(this.program,"v_alphaStart"),-1===this.alphaStartLocation)throw new Error("unable to get attribute location for v_alphaStart");this.positionBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.setRectangle(this.gl,0,0,this.videoAttributes.mp4Width,this.videoAttributes.mp4Height),this.texcoordBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.texcoordBuffer);const t=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,t),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([0+.5/this.videoAttributes.mp4Width,0+.5/this.videoAttributes.mp4Height,1-.5/this.videoAttributes.mp4Width,0+.5/this.videoAttributes.mp4Height,0+.5/this.videoAttributes.mp4Width,1-.5/this.videoAttributes.mp4Height,0+.5/this.videoAttributes.mp4Width,1-.5/this.videoAttributes.mp4Height,1-.5/this.videoAttributes.mp4Width,0+.5/this.videoAttributes.mp4Height,1-.5/this.videoAttributes.mp4Width,1-.5/this.videoAttributes.mp4Height]),this.gl.STATIC_DRAW)}loadWithCanvas(){this.renderCanvas2D=document.createElement("canvas"),this.renderCanvas2D.width=this.videoAttributes.mp4Width*this.videoAttributes.sequenceScale.width*this.viewportSize.scaleX,this.renderCanvas2D.height=this.videoAttributes.mp4Height*this.videoAttributes.sequenceScale.height*this.viewportSize.scaleY,this.renderCanvas2DContext=this.renderCanvas2D.getContext("2d")}setRectangle(t,e,i,s,r){const o=e,n=e+s,a=i,h=i+r;t.bufferData(t.ARRAY_BUFFER,new Float32Array([o,a,n,a,o,h,o,h,n,a,n,h]),t.STATIC_DRAW)}flushLoop(t,e){t.flush(e),this.renderTimer=window.requestAnimationFrame((()=>{this.flushLoop(t,e)}))}renderWithWebGL(t){this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t);const e=this.gl.getUniformLocation(this.program,"u_resolution");this.gl.viewport(this.viewportSize.x,this.viewportSize.y,this.viewportSize.width,this.viewportSize.height),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.useProgram(this.program),this.gl.enableVertexAttribArray(this.positionLocation),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer);const i=this.gl.FLOAT;this.gl.vertexAttribPointer(this.positionLocation,2,i,false,0,0),this.gl.enableVertexAttribArray(this.texcoordLocation),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.texcoordBuffer),this.gl.vertexAttribPointer(this.texcoordLocation,2,i,false,0,0),this.gl.uniform2f(e,this.videoAttributes.videoWidth,this.videoAttributes.videoHeight),this.videoAttributes.hasAlpha&&this.gl.uniform2f(this.alphaStartLocation,this.videoAttributes.alphaStartX/this.videoAttributes.mp4Width,this.videoAttributes.alphaStartY/this.videoAttributes.mp4Height),this.gl.uniform2f(this.scaleLocation,this.videoAttributes.sequenceScale.width,this.videoAttributes.sequenceScale.height);const s=this.gl.TRIANGLES;this.gl.drawArrays(s,0,6)}renderWithCanvas(t){if(0!==this.videoAttributes.videoWidth&&0!==this.videoAttributes.videoHeight)if(this.videoAttributes.hasAlpha){this.renderCanvas2DContext.clearRect(0,0,this.renderCanvas2D.width,this.renderCanvas2D.height),this.renderCanvas2DContext.drawImage(t,0,0,this.renderCanvas2D.width,this.renderCanvas2D.height);const e=this.renderCanvas2DContext.getImageData(0,0,this.viewportSize.width,this.viewportSize.height),i=this.renderCanvas2DContext.getImageData(this.videoAttributes.alphaStartX*this.videoAttributes.sequenceScale.width*this.viewportSize.scaleX,this.videoAttributes.alphaStartY*this.videoAttributes.sequenceScale.height*this.viewportSize.scaleY,this.viewportSize.width,this.viewportSize.height),s=e.data.length/4;for(let t=0;t<s;t++)e.data[4*t+3]=i.data[4*t+0];this.context2D.clearRect(0,0,this.canvas.width,this.canvas.height),this.context2D.putImageData(e,this.viewportSize.x,this.viewportSize.y,0,0,this.viewportSize.width,this.viewportSize.height)}else this.context2D.drawImage(t,0,0,this.videoAttributes.sequenceWidth,this.videoAttributes.sequenceHeight,this.videoAttributes.position.x,this.videoAttributes.position.y,this.videoAttributes.videoWidth,this.videoAttributes.videoHeight)}clearRenderWithWebGL(){this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT)}clearRenderWithCanvas(){this.context2D.clearRect(0,0,this.canvas.width,this.canvas.height)}clearRenderTimer(){this.renderTimer&&(window.cancelAnimationFrame(this.renderTimer),this.renderTimer=null)}};let ye=fe;ye.renderingMode=re,ye.scaleMode=he,t.PAGFile=le,t.PAGGenerator=se,t.PAGView=ye,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=pag.min.js.map
